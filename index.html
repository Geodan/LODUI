<!DOCTYPE html>
<html>
<head>
    <title>LODUI map</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    
    <!-- D3 -->
    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
	<script src="http://d3js.org/d3.geo.tile.v0.min.js"></script>
    <script src="http://d3js.org/topojson.v1.min.js"></script>
	<script src="./libs/nvd3.min.js"></script>
    <script src="./libs/queue.v1.min.js"></script>

	<!-- Bootstrap -->
	<link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
	<link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap-theme.min.css">
	<!--<script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>-->
	
    <script src="./libs/underscore/underscore-min.js"></script>
	<script src="./src/map.js"></script>
	<script src="./src/layer.js"></script>
	<script src="./src/queries.js"></script>
	<script src="./src/dataprocessing.js"></script>
	<link rel="stylesheet" href="./libs/nvd3.css" />
	<link rel="stylesheet" href="./css/main.css" />
    
    <!-- CUSTOM--> 
    <style>
	#gemeenten {
		fill: black;
		fill-opacity: 0.4;
		stroke: grey;
		
	}
	#buurten {
		fill: steelBlue;
		fill-opacity: 0.2;
		stroke: steelBlue;
	}
	circle {
		fill: steelBlue;
		stroke: steelBlue;
		stroke-width: 1px;
	}
	.graph {
		stroke: steelBlue;
		fill: none;
	}
	
	#maptooltip {
		position: absolute;
	}
	
	#map {
		height: 400px;
	}
	
	#table {
		height: 300px;
		width: 50%;
		overflow: auto;
		padding: 40px;
	}
   
    </style>
</head>
<body>
<div id='controls' class="page-header">
	<h1>Cerise demo app</h1>
</div>
<div class="row">

	<div id='map' class="col-md-6"></div>
	<div id='infobox' class="col-md-6">
		Info
	</div>
</div>
<div class="row">
	<div id='table' class="col-md-6"></div>
</div>


<script>

var map = new lodui.map('map', {center: [4.740008,52.892394]});

var gemeentelayer = map.layers('gemeenten', {});
d3.json("./data/cbs2013/gemeenten.topojson", function(error, data) {
  var areas = topojson.feature(data, data.objects.gemeenten);
  for (var i = 0; i < areas.features.length; i++ ){
	areas.features[i].id = i;
  }
  //gemeentelayer.data(areas.features);
  map.redraw();
});
	
var querymeter = function(d){
	var meter = d.properties.meter;
	var request_url = queries.getMeterValues(meter);
	var address = d.properties;
	var data = null;
	d3.csv(request_url, function(response){
		/* Prepare the data */
		var processor = new lodui.dataprocessor();
		var data = processor.data(response).filter('year', 2013).group('month').map('month', 'waarde').data();
		d.r = data[0].y / 100;
		map.redraw(); //that's 72 redraws.....
	});	
}	

/** Show a tooltip with meterinfo **/
var meterinfo = function(d,e){
	var loc = d3.mouse(d3.select('#map')[0][0]);
	var div = d3.select('#maptooltip');
	div.style('left', loc[0] + 20 + 'px').style('top', loc[1] + 5 + 'px').html(d.id);
	div.classed("mouseover label label-primary", true).style('display','block');
}

/** Define meters layer **/
var meterslayer = map.layers('meters', {
	type: 'point',
	style: {
		fill: 'red'
	},
	onmouseover: meterinfo,
	onclick: function(d, elem){
		d3.selectAll('circle').style('fill','steelBlue');
		d3.select(elem).style('fill', 'orange');
		//querymeter(d);
		}
	});


var queries = new lodui.queries();
var request_url = queries.geocodedMeters();
//Get a list of gas-meters
d3.csv(request_url, function(response){
	var collection = {"type":"FeatureCollection","features":[]}; 
	response.forEach(function(d,i){
		var coords = d.geom.replace('POINT(','').replace(')','').split(' ');
		d.x = parseFloat(coords[0]);
		d.y = parseFloat(coords[1]);
		var feature = {
			id: i,
			type: 'Feature',
			properties: d,
			geometry: {type: 'Point', coordinates: [d.x, d.y]}
		};
		collection.features.push(feature);
		querymeter(feature);
	});
	
	//WORK IN PROGRESS:
	var rows = d3.select('#table').classed('list-group', true).selectAll('.row').data(collection.features, function(d){return d.id});
	var newrow = rows.enter().append('li').classed('row list-group-item', true);
	newrow.html(function(d){
			var address = d.properties;
			return '<small>' + address.straat + ' ' + address.nummer + (address.letter || '' ) + address.woonplaats  + '</small>';
		});
	newrow.on('mouseover', function(d){})
	rows.exit().remove();
	meterslayer.data(collection.features);
	map.redraw();
});

</script>

</body>
</html>